

<!DOCTYPE html>
<html>
<head>
<title>Rocket</title>
<!-- <link rel="icon" type="image/x-icon" href="./images/favicon.ico"> -->
</head>
<body>

<canvas id="myCanvas" style="border:2px solid"></canvas>
  <script>

var canvas = document.getElementById("myCanvas");
  var c = canvas.getContext("2d");

  canvas.width = window.innerWidth - 20;
  canvas.height = window.innerHeight - 100;

  var simMinWidth = 20.0;
  var cScale = Math.min(canvas.width, canvas.height) / simMinWidth;
  var simWidth = canvas.width / cScale;
  var simHeight = canvas.height / cScale;
  const heightData=[];
  const apogeeData=[];

    function dot(v1,v2){
      return v1.x*v2.x+v1.y*v2.y;
    }
    function mag(v){
      return Math.sqrt(v.x*v.x+v.y*v.y);
    }
    function addv(v1,v2){
      return{x:v1.x+v2.x,y:v1.y+v2.y};
    }
    function subtractv(v1,v2){
      return {x:v1.x-v2.x,y:v1.y-v2.y};
    }

  function cX(pos) {
    return pos.x * cScale;
  }

  function cY(pos) {
    return canvas.height - pos.y * cScale;
  }

  // scene -------------------------------------------------------

  var gravity = { x: 0.0, y: -9.8};
  var dt = 1.0 / 100.0;
  var time=0;
    var rocket = {pos:{x:0.75*canvas.width/cScale
    ,y:0},vel:{x:0.0,y:0.0}};
var scale=12;
    var rocketHeight =6/scale;
    var rocketWidth = 3/scale;
    var mass = 0.5;
    //in impulse remaining
    var fuel = 50;
    var burnTime=1.3
    var averageThrust=fuel/1.3;
    var surfaceArea=0.00387096;
    var airBrakeArea=0.00116129;
    var airBrakeOn=0;
    var CD=0.7;
    var density=1.225;
    var targetApogee=215;
  
    var peakHeight=0;
  // drawing -------------------------------------------------------

  function draw() {
    c.clearRect(0, 0, canvas.width, canvas.height);
   c.beginPath();
    var scale2=30;
      c.fillText("target apogee:   "+String(targetApogee), 10, 40);
     c.fillText("height:   "+String(rocket.pos.y), 10, 50);
       c.fillText("time:   " + String(time), 10, 60);
          c.fillText("apogee/peak height: " + String(peakHeight), 10, 70);
          c.fillText("predicted apogee:  "+String( findApogee(rocket.pos.y,rocket.vel.y,angle)),10,80);
           c.fillText("fuel (measured in total remaining impulse):  " + String(fuel.toFixed(3)),10,90);
           c.fillText("possible air break changes:  " + (count-2),10,100);
            c.fillText("velocity:  " + rocket.vel.y,10,110);
            c.fillText("300m  " ,10,-10+canvas.height - cScale*(5+(300/scale2)));
            c.strokeStyle = "black";
           
            if(time<14){
        
              heightData.push({x:1+heightData.length*0.5/scale2,y:5+rocket.pos.y/scale2});
                  if(rocket.vel.y>-5){ 
                    apogeeData.push({x:1+apogeeData.length*0.5/scale2,y:5+findApogee(rocket.pos.y,rocket.vel.y,angle)/scale2});}
                      }
            for(var  i=0;i<heightData.length;i++){
            c.rect(cX(heightData[i]),cY(heightData[i]),cScale*0.5/scale2,cScale*0.5/scale2);
            }
            c.stroke();
            c.beginPath();
c.strokeStyle = "red";
          for(var  i=0;i<apogeeData.length;i++){
             c.rect(cX(apogeeData[i]),cY(apogeeData[i]),cScale*0.5/scale2,cScale*0.5/scale2);
            }
c.moveTo(cScale*1, 1+canvas.height - 5 * cScale);
c.lineTo(25*cScale, 1+canvas.height - 5 * cScale);
c.moveTo(cScale*1, 1+canvas.height - 5 * cScale);
 c.lineTo(1*cScale, 1+canvas.height - cScale*(5+(300/scale2)));
var displayRocket ={x:rocket.pos.x,y:(rocket.pos.y)/scale+rocketHeight}; c.rect(cX(displayRocket),cY(displayRocket),rocketWidth*cScale,rocketHeight*cScale);
var displayAirbrake = {x:rocket.pos.x-1.5*rocketWidth,y:(rocket.pos.y)/scale+0.6*rocketHeight};
if(airBrakeOn>0){
c.rect(cX(displayAirbrake),cY(displayAirbrake),4*rocketWidth*cScale,0.5*rocketHeight*cScale);
}
   //c.rect(98.0,10, rocketWidth,rocketHeight);
c.stroke();
c.closePath();
  }

  // simulation ----------------------------------------------------

 var down = false;
    var up =false;
    var angle=0;
    
    //in actual flight, CD will be approximated at each point probably
    function findApogee(height,yvel,a){
    var altitude=height;
    var vel =yvel;
    while(vel>0){
   vel-=dt*(0.5*CD*density*vel*vel*(surfaceArea+airBrakeArea*airBrakeOn))/mass;
    vel+= gravity.y * dt;
  altitude+= Math.cos(a)*vel * dt;
  }
  return altitude;
    }

    
    
  function simulate() {
    //drag
    if(rocket.vel.y>0){
      //ascending
    rocket.vel.y-=dt*(0.5*CD*density*rocket.vel.y*rocket.vel.y*(surfaceArea+airBrakeArea*airBrakeOn))/mass;
    }
    else{
      //falling (no parachute)
    rocket.vel.y+=dt*(0.5*CD*density*rocket.vel.y*rocket.vel.y*surfaceArea)/mass
    }
    //gravity
     rocket.vel.y += gravity.y * dt;
     //thrust
    if(fuel>0){
    rocket.vel.y+=dt*averageThrust/mass
    fuel-=averageThrust*dt
    }
    //every 0.2 seconds choose airbrake position
 if(time>count*0.2){
     count++
  //only deploy airbrakes if rising and post burn     
      if(fuel<=0&&rocket.vel.y>0){
      var dif=0;
         if(findApogee(rocket.pos.y,rocket.vel.y,angle)>targetApogee){
             dif=findApogee(rocket.pos.y,rocket.vel.y,angle)-targetApogee;
             airBrakeOn=1;
           
               if(Math.abs(targetApogee-findApogee(rocket.pos.y,rocket.vel.y,angle))>dif){
                 //delete if using other method
                   airBrakeOn=0;
               }
       }
       else if(findApogee(rocket.pos.y,rocket.vel.y,angle)<=targetApogee){
            dif=Math.abs(findApogee(rocket.pos.y,rocket.vel.y,angle)-targetApogee);
             airBrakeOn=0;
              if(Math.abs(targetApogee-findApogee(rocket.pos.y,rocket.vel.y,angle))>dif){
                //delete if using other method
                   airBrakeOn=1;
                 }
         }
   }
   }
    
   //no airbrakes when descending ever
    
   if(rocket.vel.y<0){
   airBrakeOn=0
   }
   
   rocket.pos.x += rocket.vel.x * dt;
    //rough wind simulation, currently set to 0.
   if(rocket.pos.y>180){
   angle=0;
   }
    //angle is wind
  rocket.pos.y+= Math.cos(angle)*rocket.vel.y * dt;
//keep track of apogee
  if(rocket.pos.y>peakHeight){
  peakHeight=rocket.pos.y;
  }
    //dont fall through ground
     if (rocket.pos.y < 0) {
      rocket.pos.y = 0;
      rocket.vel.y =0;
    }
  }

  var up = false;
  var down  =false;
  var count=0;
  function update() {
    
   document.addEventListener('keydown', function(event) {
     //ignore the following few lines, potential feature not yet implemented
        if(event.keyCode == 38) {
          
          up=true;
        }
        else if(event.keyCode == 40) {
          down=true;
                    
        }
     });
     
    document.addEventListener('keyup', function(event) {
  
         if(event.keyCode == 38) {
          
          up=false;
          
        }
        else if(event.keyCode == 40) {
          down=false;
        }
     });
    
    //Main loop
    simulate();
    draw();
    time+=dt;
    requestAnimationFrame(update);
  }
 update();

  </script>

</body>
</html>
